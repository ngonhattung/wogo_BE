@startuml
!include sequence-style.puml


actor Client as "<size:27>Client</size>"
participant Controller as "Controller"
participant VerifySvc as "VerifySvc"
participant WVTService as "WVT-Svc"
participant WVTRepo as "WVT-Repo"
participant WVService as "WV-Svc"
participant WVRepo as "WV-Repo"
participant UserSvc as "UserSvc"
participant UserRepo as "UserRepo"
participant WorkerSvc as "WorkerSvc"
participant WorkerRepo as "WorkerRepo"
participant WSSvc as "WS-Svc"
participant WSRepo as "WS-Repo"
participant WWESvc as "WWE-Svc"
participant WWERepo as "WWE-Repo"
participant WWRSvc as "WWR-Svc"
participant WWRRepo as "WWR-Repo"

Client -> Controller: <size:27>1. POST /complete-test</size>
activate Controller

Controller -> VerifySvc: <size:27>1.1. completeWorkerTest(request)</size>
activate VerifySvc

VerifySvc -> WVTService: <size:27>2.1. getWorkerVerificationTestById(testId)</size>
activate WVTService
WVTService -> WVTRepo: <size:27>2.1.1. findById(testId)</size>
activate WVTRepo
WVTRepo --> WVTService: <size:27>WorkerVerificationTest (test)</size>
deactivate WVTRepo
deactivate WVTService

VerifySvc -> WVService: <size:27>2.2. getWorkerVerificationByWorkerTestId(testId)</size>
activate WVService
WVService -> WVRepo: <size:27>2.2.1. findByWorkerTestId(testId)</size>
activate WVRepo
WVRepo --> WVService: <size:27>WorkerVerification (verification)</size>
deactivate WVRepo
deactivate WVService

VerifySvc -> VerifySvc: <size:27>2.3. calculateCorrectAndAddHistoryAnswers(answers, test)</size>
note right: <size:27>Tính số câu đúng & lưu lịch sử</size>

VerifySvc -> VerifySvc: <size:27>2.4. Calculate scorePercentage</size>
VerifySvc -> VerifySvc: <size:27>2.5. Check isPassed</size>

VerifySvc -> WVTRepo: <size:27>2.6. Update test status & score\n<size:27>(setPassed, setScorePercentage, setTestStatus)</size>
VerifySvc -> WVRepo: <size:27>2.7. Update verification status\n<size:27>(setVerificationStatus)

alt <size:27>[3. Test Passed
    VerifySvc -> WVRepo: <size:27>3.1.1. Get User
    VerifySvc -> WVTRepo: <size:27>3.1.2. Get QuestionCategory
    VerifySvc -> WVTRepo: <size:27>3.1.3. Get Service (qua QuestionCategory)

    VerifySvc -> UserSvc: <size:27>3.2.1. isExistRole(userId, ROLE.WORKER)
    activate UserSvc
    UserSvc -> UserRepo: <size:27>3.2.1.1. existsByUserIdAndRoleName\n<size:27>(userId, "WORKER")
    activate UserRepo
    UserRepo --> UserSvc: <size:27>boolean
    deactivate UserRepo

    alt 3.2.2. Role Not Exists
        UserSvc -> UserRepo: <size:27>3.2.2.1. addRoleToUser(userId, "WORKER")
        activate UserRepo
        UserRepo --> UserSvc: <size:27>void
        deactivate UserRepo
    end
    deactivate UserSvc

    VerifySvc -> WorkerSvc: <size:27>3.3.1. isWorkerExists(userId)
    activate WorkerSvc
    WorkerSvc -> WorkerRepo: <size:27>3.3.1.1. existsByUserId(userId)
    activate WorkerRepo
    WorkerRepo --> WorkerSvc: <size:27>boolean
    deactivate WorkerRepo

    alt <size:27>3.3.2. Worker Not Exists
        WorkerSvc -> WorkerRepo: <size:27>3.3.2.1. save(new Worker)
        activate WorkerRepo
        WorkerRepo --> WorkerSvc: <size:27>Worker instance
        deactivate WorkerRepo
    else 3.3.3. Worker Exists
        WorkerSvc -> WorkerRepo: <size:27>3.3.3.1. findByUserId(userId)
        activate WorkerRepo
        WorkerRepo --> WorkerSvc: <size:27>Worker instance
        deactivate WorkerRepo
    end
    deactivate WorkerSvc

    VerifySvc -> WSSvc: <size:27>3.4. saveWorkerService(worker, service)
    activate WSSvc
    WSSvc -> WSRepo: <size:27>3.4.1. save(workerService)
    activate WSRepo
    WSRepo --> WSSvc: <size:27>WorkerService
    deactivate WSRepo
    deactivate WSSvc

    VerifySvc -> WWESvc: <size:27>3.5. checkExistWalletByWorkerId(workerId)
    activate WWESvc
    WWESvc -> WWERepo: <size:27>3.5.1. existsByWorkerId(workerId)
    activate WWERepo
    WWERepo --> WWESvc: <size:27>boolean (expenseExists)
    deactivate WWERepo
    deactivate WWESvc

    VerifySvc -> WWRSvc: <size:27>3.6. checkExistWalletByWorkerId(workerId)
    activate WWRSvc
    WWRSvc -> WWRRepo: <size:27>3.6.1. existsByWorkerId(workerId)
    activate WWRRepo
    WWRRepo --> WWRSvc: <size:27>boolean (revenueExists)
    deactivate WWRRepo
    deactivate WWRSvc

    alt <size:27>3.7. Both Wallets Not Exist
        VerifySvc -> WWESvc: <size:27>3.7.1. saveWorkerWalletExpense(requestDTO)
        activate WWESvc
        WWESvc -> WWERepo: <size:27>3.7.1.1. save(new Wallet)
        activate WWERepo
        WWERepo --> WWESvc: <size:27>WorkerWalletExpense
        deactivate WWERepo
        deactivate WWESvc

        VerifySvc -> WWRSvc: <size:27>3.7.2. saveWorkerWalletRevenue(requestDTO)
        activate WWRSvc
        WWRSvc -> WWRRepo: <size:27>3.7.2.1. save(new Wallet)
        activate WWRRepo
        WWRRepo --> WWRSvc: <size:27>WorkerWalletRevenue
        deactivate WWRRepo
        deactivate WWRSvc
    end
end

VerifySvc -> WVTService: <size:27>4.1. updateWorkerVerificationTest(testId, updateDTO)
activate WVTService
WVTService -> WVTRepo: <size:27>4.1.1. save(workerVerificationTest)
activate WVTRepo
WVTRepo --> WVTService: <size:27>WorkerVerificationTest
deactivate WVTRepo
deactivate WVTService

VerifySvc -> WVService: <size:27>4.2. updateWorkerVerification(verificationId, updateDTO)
activate WVService
WVService -> WVRepo: <size:27>4.2.1. save(workerVerification)
activate WVRepo
WVRepo --> WVService: <size:27>WorkerVerification
deactivate WVRepo
deactivate WVService

VerifySvc -> VerifySvc: <size:27>4.3. Build CompleteTestResponseDTO

VerifySvc --> Controller: <size:27>4.4. CompleteTestResponseDTO
deactivate VerifySvc

Controller -> Controller: <size:27>5. Build ApiResponse

Controller --> Client: <size:27>5.1. ApiResponse
deactivate Controller

@enduml