@startuml
!include sequence-style.puml

actor Client as "<size:27>Client</size>"
participant "WorkerController" as Controller
participant "WorkerVerifyService" as VerifyService
participant "WorkerServiceService" as WSService
participant "WorkerServiceRepository" as WSRepo
participant "QuestionCategoryService" as QCService
participant "QuestionCategoryRepository" as QCRepo
participant "WorkerVerificationTestService" as WVTService
participant "WorkerVerificationTestRepository" as WVTRepo
participant "WorkerVerificationService" as WVService
participant "WorkerVerificationRepository" as WVRepo
participant "QuestionService" as QService
participant "QuestionRepository" as QRepo

Client -> Controller: <size:27>1. POST /create-test</size>
activate Controller

Controller -> VerifyService: <size:27>1.1. createWorkerTest(request)</size>
activate VerifyService

VerifyService -> WSService: <size:27>2.1. checkWorkerServiceExists(serviceId)</size>
activate WSService

WSService -> WSService: <size:27>SecurityUtils.getCurrentUserId()</size>
WSService -> WSRepo: <size:27>2.1.1. existsByUserIdAndServiceId\n<size:27>(userId, serviceId)</size>
activate WSRepo
WSRepo --> WSService: <size:27>boolean</size>
deactivate WSRepo

alt <size:27>2.2. Worker Service Already Exists</size>
    WSService --> VerifyService: <size:27>true</size>
    deactivate WSService
    VerifyService --> Controller: <size:27>throw AppException\n<size:27>(WORKER_SERVICE_EXISTS)</size>
    Controller --> Client: <size:27>Error Response</size>
else <size:27>2.3. Worker Service Not Exists</size>
    WSService --> VerifyService: <size:27>false</size>
    deactivate WSService

    VerifyService -> QCService: <size:27>3.1. getCategoryEntityByServiceId(serviceId)</size>
    activate QCService

    QCService -> QCRepo: <size:27>3.1.1. findByServiceId(serviceId)</size>
    activate QCRepo
    QCRepo --> QCService: <size:27>Optional<QuestionCategory></size>
    deactivate QCRepo

    alt <size:27>3.2. Category Not Found</size>
        QCService --> VerifyService: <size:27>throw AppException\n<size:27>(QUESTION_CATEGORY_NOT_FOUND)</size>
        VerifyService --> Controller: <size:27>Error</size>
        Controller --> Client: <size:27>Error Response</size>
    else <size:27>3.3. Category Found</size>
        QCService --> VerifyService: <size:27>QuestionCategory</size>
        deactivate QCService

        VerifyService -> WVTService: <size:27>4.1. saveWorkerVerificationTest(requestDTO)</size>
        activate WVTService
        WVTService -> WVTRepo: <size:27>4.1.1. save(workerVerificationTest)</size>
        activate WVTRepo
        WVTRepo --> WVTService: <size:27>WorkerVerificationTest</size>
        deactivate WVTRepo
        deactivate WVTService
        VerifyService --> WVTService: <size:27>WorkerVerificationTest</size>

        VerifyService -> WVService: <size:27>5.1. saveWorkerVerification(requestDTO)</size>
        activate WVService
        WVService -> WVRepo: <size:27>5.1.1. save(workerVerification)</size>
        activate WVRepo
        WVRepo --> WVService: <size:27>WorkerVerification</size>
        deactivate WVRepo
        deactivate WVService
        VerifyService --> WVService: <size:27>WorkerVerification</size>

        VerifyService -> QService: <size:27>6.1. findRandomQuestions(categoryId)</size>
        activate QService

        loop <size:27>For Each Difficulty Level \n<size:27>(EASY, MEDIUM, HARD)</size>
            QService -> QService: <size:27>getRandomQuestions\n<size:27>(categoryId, level, needed)</size>

            QService -> QRepo: <size:27>6.1.1. findRandomByDifficulty\n<size:27>(categoryId, level, needed*2)</size>
            activate QRepo
            QRepo --> QService: <size:27>List<Question></size>
            deactivate QRepo

            QService -> QService: <size:27>Shuffle & Limit questions</size>
        end

        QService -> QService: <size:27>convert to QuestionResponseDTO</size>
        QService --> VerifyService: <size:27>List<QuestionResponseDTO></size>
        deactivate QService

        VerifyService -> VerifyService: <size:27>7.1. Build CreateTestResponseDTO</size>

        VerifyService --> Controller: <size:27>7.2. CreateTestResponseDTO</size>
        deactivate VerifyService

        Controller -> Controller: <size:27>8. Build ApiResponse</size>

        Controller --> Client: <size:27>8.1. ApiResponse</size>
        deactivate Controller
    end
end
@enduml