@startuml
!include sequence-style.puml
title Create Payment Sequence Diagram

actor Client
participant "Controller\n(BookingController)" as Controller
participant "BookingService" as BookingSvc
participant "BookingRepository" as BookingRepo
participant "<<entity>>\nBooking" as BookingEntity
participant "WorkerWalletRevenueService" as WWRSvc
participant "WorkerWalletRevenueRepository" as WWRRepo
participant "<<entity>>\nWorkerWalletRevenue" as WWREntity
participant "WalletTransactionService" as WTSvc
participant "WalletTransactionRepository" as WTRepo
participant "<<entity>>\nWalletTransaction" as WTEntity
participant "PaymentService" as PaymentSvc
participant "PaymentRepository" as PaymentRepo
participant "<<entity>>\nPayment" as PaymentEntity
participant "SepayVerifyService" as SepaySvc

Client -> Controller: POST /create-payment/{bookingCode}
activate Controller

Controller -> BookingSvc: createBookingTransaction(bookingCode)
activate BookingSvc

== Get Booking ==
BookingSvc -> BookingRepo: findByBookingCode(bookingCode)
activate BookingRepo
BookingRepo -> BookingEntity: query by bookingCode
activate BookingEntity

alt Booking Not Found
    BookingEntity --> BookingRepo: null
    deactivate BookingEntity
    BookingRepo --> BookingSvc: Optional.empty()
    deactivate BookingRepo
    BookingSvc --> Controller: throw AppException\n(BOOKING_NOT_FOUND)
    Controller --> Client: Error Response
else Booking Found
    BookingEntity --> BookingRepo: Booking instance
    deactivate BookingEntity
    BookingRepo --> BookingSvc: Optional<Booking>
    deactivate BookingRepo

    == Validate Booking Amount ==
    BookingSvc -> BookingEntity: getTotalAmount()
    activate BookingEntity
    BookingEntity --> BookingSvc: BigDecimal totalAmount
    deactivate BookingEntity

    alt Invalid Amount (null or <= 0)
        BookingSvc --> Controller: throw AppException\n(INVALID_BOOKING_AMOUNT)
        Controller --> Client: Error Response
    else Valid Amount

        == Get Worker Wallet Revenue ==
        BookingSvc -> WWRSvc: getWalletByUserId()
        activate WWRSvc

        WWRSvc -> WWRSvc: SecurityUtils.getCurrentUserId()

        WWRSvc -> WWRRepo: findByWorkerId(userId)
        activate WWRRepo
        WWRRepo -> WWREntity: query by workerId
        activate WWREntity
        WWREntity --> WWRRepo: WorkerWalletRevenue instance
        deactivate WWREntity
        WWRRepo --> WWRSvc: WorkerWalletRevenue
        deactivate WWRRepo

        WWRSvc --> BookingSvc: WorkerWalletRevenue
        deactivate WWRSvc

        == Calculate Worker Amount ==
        BookingSvc -> BookingEntity: getPlatformFee()
        activate BookingEntity
        BookingEntity --> BookingSvc: BigDecimal platformFee
        deactivate BookingEntity

        BookingSvc -> BookingSvc: workerAmount = totalAmount - platformFee
        note right: Worker receives amount\nminus platform commission

        == Get Current Balance ==
        BookingSvc -> WWREntity: getRevenueBalance()
        activate WWREntity
        WWREntity --> BookingSvc: BigDecimal revenueBalance
        deactivate WWREntity

        BookingSvc -> BookingSvc: balanceAfter = revenueBalance + workerAmount

        == Save Wallet Transaction ==
        BookingSvc -> WTSvc: saveWalletTransaction(WalletTransactionRequestDTO)
        activate WTSvc

        WTSvc -> WTRepo: save(walletTransaction)
        activate WTRepo
        WTRepo -> WTEntity: persist new WalletTransaction\n(amount=totalAmount,\ntransactionType=PAYMENT,\nstatus=PENDING,\ndescription="Payment for booking: " + bookingCode,\nwalletRevenue=walletRevenue,\nbalanceBefore=revenueBalance,\nbalanceAfter=revenueBalance + workerAmount)
        activate WTEntity
        WTEntity --> WTRepo: WalletTransaction instance
        deactivate WTEntity
        WTRepo --> WTSvc: WalletTransaction
        deactivate WTRepo

        WTSvc --> BookingSvc: WalletTransaction
        deactivate WTSvc

        == Save Payment ==
        BookingSvc -> PaymentSvc: savePayment(PaymentRequestDTO)
        activate PaymentSvc

        PaymentSvc -> PaymentRepo: save(payment)
        activate PaymentRepo
        PaymentRepo -> PaymentEntity: persist new Payment\n(booking=booking,\namount=totalAmount,\npaymentMethod=BANK_TRANSFER)
        activate PaymentEntity
        PaymentEntity --> PaymentRepo: Payment instance
        deactivate PaymentEntity
        PaymentRepo --> PaymentSvc: Payment
        deactivate PaymentRepo

        PaymentSvc --> BookingSvc: Payment
        deactivate PaymentSvc

        == Generate QR Code for Payment ==
        BookingSvc -> SepaySvc: createQRCodeForPayment(booking)
        activate SepaySvc

        SepaySvc -> SepaySvc: Call Sepay API\nwith booking details
        note right: External API call\nto Sepay payment gateway\nNo entity involved

        SepaySvc --> BookingSvc: String linkQR
        deactivate SepaySvc

        == Build Response ==
        BookingSvc -> BookingSvc: TransactionResponseDTO.builder()\n.linkTransaction(linkQR)\n.transactionStatus(false)\n.build()
        note right: transactionStatus=false\nmeans payment is pending

        BookingSvc --> Controller: TransactionResponseDTO
        deactivate BookingSvc

        Controller -> Controller: ApiResponse.builder()\n.message("Create payment successfully")\n.result(transactionResponseDTO)\n.build()

        Controller --> Client: ApiResponse<TransactionResponseDTO>
        deactivate Controller
    end
end


@enduml
