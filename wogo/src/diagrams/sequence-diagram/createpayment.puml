@startuml
!include sequence-style.puml

actor Client as "<size:27>Client</size>"
participant "BookingController" as Controller
participant "BookingService" as BookingSvc
participant "BookingRepository" as BookingRepo
participant "WorkerWalletRevenueService" as WWRSvc
participant "WorkerWalletRevenueRepository" as WWRRepo
participant "WalletTransactionService" as WTSvc
participant "WalletTransactionRepository" as WTRepo
participant "PaymentService" as PaymentSvc
participant "PaymentRepository" as PaymentRepo
participant "SepayVerifyService" as SepaySvc

Client -> Controller: <size:27>1. POST /create-payment/{bookingCode}</size>
activate Controller

Controller -> BookingSvc: <size:27>1.1. createBookingTransaction(bookingCode)</size>
activate BookingSvc

BookingSvc -> BookingRepo: <size:27>2.1. findByBookingCode(bookingCode)</size>
activate BookingRepo
BookingRepo --> BookingSvc: <size:27>Optional<Booking></size>
deactivate BookingRepo

alt <size:27>[2.2. Booking Not Found]</size>
    BookingSvc --> Controller: <size:27>throw AppException\n<size:27>(BOOKING_NOT_FOUND)</size>
    Controller --> Client: <size:27>Error Response</size>
else <size:27>2.3. Booking Found</size>

    BookingSvc -> BookingSvc: <size:27>2.3.1. Get totalAmount & Validate</size>

    alt <size:27>[2.3.2. Invalid Amount (null or <= 0)]</size>
        BookingSvc --> Controller: <size:27>throw AppException\n<size:27>(INVALID_BOOKING_AMOUNT)</size>
        Controller --> Client: <size:27>Error Response</size>
    else <size:27>[2.3.3. Valid Amount]</size>

        BookingSvc -> WWRSvc: <size:27>3.1. getWalletByUserId()</size>
        activate WWRSvc
        WWRSvc -> WWRSvc: <size:27>SecurityUtils.getCurrentUserId()</size>
        WWRSvc -> WWRRepo: <size:27>3.1.1. findByWorkerId(userId)</size>
        activate WWRRepo
        WWRRepo --> WWRSvc: <size:27>WorkerWalletRevenue</size>
        deactivate WWRRepo
        WWRSvc --> BookingSvc: <size:27>WorkerWalletRevenue</size>
        deactivate WWRSvc

        BookingSvc -> BookingSvc: <size:27>3.2. Calculate workerAmount</size>
        note right: <size:27>workerAmount = \n<size:27>totalAmount - platformFee

        BookingSvc -> BookingSvc: <size:27>3.3. Get revenueBalance & Calculate balanceAfter</size>

        BookingSvc -> WTSvc: <size:27>4.1. saveWalletTransaction(WalletTransactionRequestDTO)</size>
        activate WTSvc
        WTSvc -> WTRepo: <size:27>4.1.1. save(walletTransaction)</size>
        activate WTRepo
        WTRepo --> WTSvc: <size:27>WalletTransaction</size>
        deactivate WTRepo
        deactivate WTSvc

        BookingSvc -> PaymentSvc: <size:27>5.1. savePayment(PaymentRequestDTO)</size>
        activate PaymentSvc
        PaymentSvc -> PaymentRepo: <size:27>5.1.1. save(payment)</size>
        activate PaymentRepo
        PaymentRepo --> PaymentSvc: <size:27>Payment</size>
        deactivate PaymentRepo
        deactivate PaymentSvc

        BookingSvc -> SepaySvc: <size:27>6.1. createQRCodeForPayment(booking)</size>
        activate SepaySvc
        SepaySvc -> SepaySvc: <size:27>Call Sepay API</size>
        note right: <size:27> External API call\n<size:27>to Sepay payment gateway

        SepaySvc --> BookingSvc: <size:27>String linkQR</size>
        deactivate SepaySvc

        BookingSvc -> BookingSvc: <size:27>7.1. Build TransactionResponseDTO</size>
        note right: <size:27>transactionStatus=false\n<size:27>(payment is pending)

        BookingSvc --> Controller: <size:27>7.2. TransactionResponseDTO</size>
        deactivate BookingSvc

        Controller -> Controller: <size:27>8. Build ApiResponse</size>

        Controller --> Client: <size:27>8.1. ApiResponse</size>
        deactivate Controller
    end
end
@enduml