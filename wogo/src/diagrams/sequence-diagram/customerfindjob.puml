@startuml
!include sequence-style.puml
title Create Job Sequence Diagram (Fixed UML-compliant + WebSocket + Timeline)

actor Client
participant "Controller\n(BookingController)" as Controller
participant "BookingService" as BookingSvc
participant "JobService" as JobSvc
participant "JobRepository" as JobRepo
participant "<<entity>>\nJob" as JobEntity
participant "ServiceService" as ServiceSvc
participant "ServiceRepository" as ServiceRepo
participant "<<entity>>\nService" as ServiceEntity
participant "UserService" as UserSvc
participant "<<entity>>\nUser" as UserEntity
participant "JobFileService" as JobFileSvc
participant "UploadToS3" as S3Upload
participant "JobFileRepository" as JobFileRepo
participant "<<entity>>\nJobFile" as JobFileEntity
participant "AddressService" as AddressSvc
participant "AddressRepository" as AddressRepo
participant "<<entity>>\nAddress" as AddressEntity
participant "NotificationService" as NotifSvc
participant "NotificationRepository" as NotifRepo
participant "<<entity>>\nNotification" as NotifEntity
participant "MessagingTemplate\n(WebSocket)" as WebSocket

Client -> Controller: POST /create-job\n(FindServiceRequestDTO + files)
activate Controller

Controller -> BookingSvc: createJob(request, files)
activate BookingSvc

== Check Existing Pending Job ==
BookingSvc -> JobSvc: getJobsByUserIdByStatus(PENDING)
activate JobSvc

JobSvc -> JobSvc: SecurityUtils.getCurrentUserId()

JobSvc -> JobRepo: findByUserIdAndStatus(userId, PENDING)
activate JobRepo
JobRepo -> JobEntity: query by userId and status=PENDING
activate JobEntity
JobEntity --> JobRepo: List<Job> instances
deactivate JobEntity
JobRepo --> JobSvc: List<Job>
deactivate JobRepo

JobSvc -> JobSvc: convert to JobResponseDTO
JobSvc --> BookingSvc: List<JobResponseDTO>
deactivate JobSvc

BookingSvc -> BookingSvc: existingJobs.stream()\n.anyMatch(job -> serviceId matches && status=PENDING)

alt Has Pending Job for Same Service
    BookingSvc --> Controller: throw AppException\n(EXISTING_PENDING_JOB_REQUEST)
    Controller --> Client: Error Response
else No Pending Job

    == Save or Update Customer Address ==
    BookingSvc -> AddressSvc: saveOrUpdateAddress(AddressRequestDTO)
    activate AddressSvc

    AddressSvc -> AddressSvc: SecurityUtils.getCurrentUserId()

    AddressSvc -> AddressRepo: findByUserIdAndRole(userId, "CUSTOMER")
    activate AddressRepo
    AddressRepo -> AddressEntity: query by userId and role
    activate AddressEntity

    alt Address Exists
        AddressEntity --> AddressRepo: Address instance
        AddressRepo --> AddressSvc: Optional<Address>
        deactivate AddressRepo

        AddressSvc -> AddressEntity: setLatitude(latitude)
        AddressSvc -> AddressEntity: setLongitude(longitude)

        AddressSvc -> AddressRepo: save(address)
        activate AddressRepo
        AddressRepo -> AddressEntity: persist updated entity
        AddressRepo --> AddressSvc: Address
        deactivate AddressRepo

    else Address Not Exists
        AddressEntity --> AddressRepo: null
        deactivate AddressEntity
        AddressRepo --> AddressSvc: Optional.empty()
        deactivate AddressRepo

        AddressSvc -> AddressRepo: save(new Address)
        activate AddressRepo
        AddressRepo -> AddressEntity: persist new Address\n(latitude, longitude, role=CUSTOMER)
        activate AddressEntity
        AddressEntity --> AddressSvc: Address instance
        deactivate AddressEntity
        AddressRepo --> AddressSvc: Address
        deactivate AddressRepo
    end

    AddressSvc --> BookingSvc: Address
    deactivate AddressSvc

    == Save Job ==
    BookingSvc -> JobSvc: saveJob(CreateJobRequestDTO, files)
    activate JobSvc

    == Get Service Entity ==
    JobSvc -> ServiceSvc: getServiceByIdEntity(serviceId)
    activate ServiceSvc
    ServiceSvc -> ServiceRepo: findById(serviceId)
    activate ServiceRepo
    ServiceRepo -> ServiceEntity: query by serviceId
    activate ServiceEntity
    ServiceEntity --> ServiceRepo: Service instance
    deactivate ServiceEntity
    ServiceRepo --> ServiceSvc: Service
    deactivate ServiceRepo
    ServiceSvc --> JobSvc: Service
    deactivate ServiceSvc

    == Create Job Entity ==
    JobSvc -> JobSvc: createJob(request, service)

    JobSvc -> UserSvc: getCurrentUser()
    activate UserSvc
    UserSvc -> UserSvc: SecurityUtils.getCurrentUserId()
    UserSvc -> UserEntity: get current User
    activate UserEntity
    UserEntity --> UserSvc: User instance
    deactivate UserEntity
    UserSvc --> JobSvc: User
    deactivate UserSvc

    JobSvc -> JobSvc: generateJobRequestCode()
    note right: Generate unique code\nfor job request

    JobSvc -> JobSvc: Job.builder()\n.service(service)\n.user(user)\n.jobRequestCode(code)\n.description(description)\n.bookingDate(bookingDate)\n.status(PENDING)\n.bookingAddress(address)\n.estimatedPriceLower(lower)\n.estimatedPriceHigher(higher)\n.longitude(longitude)\n.latitude(latitude)\n.build()

    create JobEntity
    JobSvc -> JobEntity: new Job()
    activate JobEntity

    == Save Job Files ==
    JobSvc -> JobFileSvc: saveJobFile(job, files)
    activate JobFileSvc

    alt Files Provided
        loop For Each File
            JobFileSvc -> S3Upload: uploadFileToS3(file)
            activate S3Upload
            S3Upload -> S3Upload: Upload to AWS S3
            S3Upload --> JobFileSvc: UploadS3Response\n(fileName, fileType, fileUrl)
            deactivate S3Upload

            JobFileSvc -> JobFileRepo: save(jobFile)
            activate JobFileRepo
            JobFileRepo -> JobFileEntity: persist new JobFile\n(job, fileName, fileType, fileUrl)
            activate JobFileEntity
            JobFileEntity --> JobFileRepo: JobFile instance
            deactivate JobFileEntity
            JobFileRepo --> JobFileSvc: JobFile
            deactivate JobFileRepo
        end
    else No Files or Empty
        note right of JobFileSvc: Skip file processing
    end

    JobFileSvc --> JobSvc: void
    deactivate JobFileSvc

    == Persist Job ==
    JobSvc -> JobRepo: save(job)
    activate JobRepo
    JobRepo -> JobEntity: persist Job entity
    JobEntity --> JobRepo: saved Job instance
    JobRepo --> JobSvc: Job
    deactivate JobRepo

    == Convert to Response DTO ==
    JobSvc -> JobSvc: convertToResponseDTO(savedJob)
    JobSvc -> JobEntity: getService()
    JobEntity -> ServiceEntity: Service instance
    activate ServiceEntity
    JobEntity --> JobSvc: Service
    JobSvc -> JobEntity: getUser()
    JobEntity -> UserEntity: User instance
    activate UserEntity
    JobEntity --> JobSvc: User
    JobSvc -> JobEntity: getJobFiles()
    JobEntity -> JobFileEntity: List<JobFile> instances
    activate JobFileEntity
    JobEntity --> JobSvc: List<JobFile>
    deactivate JobFileEntity

    JobSvc --> BookingSvc: JobResponseDTO
    deactivate JobSvc
    deactivate JobEntity

    == Save Notification ==
    BookingSvc -> NotifSvc: saveNotification(NotificationRequestDTO)
    activate NotifSvc

    NotifSvc -> NotifRepo: save(notification)
    activate NotifRepo
    NotifRepo -> NotifEntity: persist new Notification\n(title="Tình hình dịch vụ#" + jobCode,\ndescription="Yêu cầu dịch vụ đã được tạo",\ntype=SERVICE, targetRole=CUSTOMER,\ntargetUserId=userId)
    activate NotifEntity
    NotifEntity --> NotifRepo: Notification instance
    deactivate NotifEntity
    NotifRepo --> NotifSvc: Notification
    deactivate NotifRepo

    NotifSvc --> BookingSvc: Notification
    deactivate NotifSvc

    BookingSvc --> Controller: JobResponseDTO
    deactivate BookingSvc

    == Push Real-time Notification to Workers ==
    Controller -> WebSocket: convertAndSend(\n"/topic/new-job/" + serviceId,\njobResponseDTO)
    activate WebSocket
    WebSocket --> WebSocket: Broadcast to subscribed workers
    note right: Workers subscribe to\n/topic/new-job/{serviceId}\nto receive new jobs
    deactivate WebSocket

    == Build Response ==
    Controller -> Controller: ApiResponse.builder()\n.message("Find workers request sent successfully")\n.result(job)\n.build()

    Controller --> Client: ApiResponse<JobResponseDTO>
    deactivate Controller

    deactivate ServiceEntity
    deactivate UserEntity
end

@enduml
