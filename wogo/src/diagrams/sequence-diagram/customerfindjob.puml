@startuml
!include sequence-style.puml


actor Client as "<size:27>Client</size>"
participant Controller as "BookingController"
participant BookingSvc as "BookingService"
participant JobSvc as "JobService"
participant JobRepo as "JobRepository"
participant JobEntity as "Job"
participant ServiceSvc as "ServiceService"
participant ServiceRepo as "ServiceRepository"
participant UserSvc as "UserService"
participant JobFileSvc as "JobFileService"
participant S3 as "UploadToS3"
participant JobFileRepo as "JobFileRepository"
participant AddressSvc as "AddressService"
participant AddressRepo as "AddressRepository"
participant NotifSvc as "NotificationService"
participant NotifRepo as "NotificationRepository"
participant WebSocket as "MessagingTemplate\n(WebSocket)"

Client -> Controller: <size:27>1. POST /create-job</size>
activate Controller
Controller -> BookingSvc: <size:27>1.1. createJob(request, files)</size>
activate BookingSvc

BookingSvc -> JobSvc: <size:27>2.1. getJobsByUserIdByStatus(PENDING)</size>
activate JobSvc
JobSvc -> JobSvc: <size:27>2.1.1. SecurityUtils.getCurrentUserId()</size>
JobSvc -> JobRepo: <size:27>2.1.2. findByUserIdAndStatus(userId, PENDING)</size>
activate JobRepo
JobRepo --> JobSvc: <size:27>2.1.3. List<Job></size>
deactivate JobRepo
JobSvc -> JobSvc: <size:27>2.1.4. to JobResponseDTO</size>
JobSvc --> BookingSvc: <size:27>2.1.5. List<JobResponseDTO></size>
deactivate JobSvc

BookingSvc -> BookingSvc: <size:27>2.2. existingJobs.anyMatch</size>
alt <size:27>2.3. Same service</size>
    BookingSvc --> Controller: <size:27>2.3.1. throw AppException</size>
    Controller --> Client: <size:27>2.3.2. Error Response</size>
    deactivate BookingSvc
else <size:27>2.4. No pending job</size>

    BookingSvc -> AddressSvc: <size:27>3.1. saveOrUpdateAddress</size>
    activate AddressSvc
    AddressSvc -> AddressSvc: <size:27>3.1.1. SecurityUtils.getCurrentUserId()</size>
    AddressSvc -> AddressRepo: <size:27>3.1.2. findByUserIdAndRole(userId, CUSTOMER)</size>
    activate AddressRepo
    AddressRepo --> AddressSvc: <size:27>3.1.3. Address?</size>
    alt <size:27>3.2. Address exists</size>
        AddressSvc -> AddressSvc: <size:27>3.2.1. update latitude/longitude</size>
        AddressSvc -> AddressRepo: <size:27>3.2.2. save(address)</size>
    else <size:27>3.3. New address</size>
        AddressSvc -> AddressRepo: <size:27>3.3.1. save(new Address(role=CUSTOMER))</size>
    end
    deactivate AddressRepo
    AddressSvc --> BookingSvc: <size:27>3.4. Address</size>
    deactivate AddressSvc

    BookingSvc -> JobSvc: <size:27>4.1. saveJob</size>
    activate JobSvc

    JobSvc -> ServiceSvc: <size:27>4.1.1. getServiceByIdEntity(serviceId)</size>
    activate ServiceSvc
    ServiceSvc -> ServiceRepo: <size:27>4.1.1.1. findById(serviceId)</size>
    activate ServiceRepo
    ServiceRepo --> ServiceSvc: <size:27>4.1.1.2. Service</size>
    deactivate ServiceRepo
    ServiceSvc --> JobSvc: <size:27>4.1.2. Service</size>
    deactivate ServiceSvc

    JobSvc -> UserSvc: <size:27>4.2. getCurrentUser()</size>
    activate UserSvc
    UserSvc -> UserSvc: <size:27>4.2.1. SecurityUtils.getCurrentUserId()</size>
    UserSvc --> JobSvc: <size:27>4.2.2. User</size>
    deactivate UserSvc

    JobSvc -> JobSvc: <size:27>4.3. generateJobRequestCode()</size>
    JobSvc -> JobEntity: <size:27>4.4. new Job() / set fields</size>

    JobSvc -> JobFileSvc: <size:27>4.5.1. saveJobFile(job, files)</size>
    activate JobFileSvc
    alt <size:27> [4.5.2. Files provided]</size>
        loop <size:27>[each file]</size>
            JobFileSvc -> S3: <size:27>4.5.2.1. uploadFileToS3(file)</size>
            activate S3
            S3 --> JobFileSvc: <size:27>4.5.2.2. UploadS3Response (url, etc.)</size>
            deactivate S3

            JobFileSvc -> JobFileRepo: <size:27>4.5.2.3. save(jobFile)</size>
            activate JobFileRepo
            JobFileRepo --> JobFileSvc: <size:27>4.5.2.4. JobFile</size>
            deactivate JobFileRepo
        end
    else <size:27>[4.5.3. No files]</size>
        note right: <size:27>skip file processing</size>
    end
    JobFileSvc --> JobSvc: <size:27>4.5.4. void</size>
    deactivate JobFileSvc

    JobSvc -> JobRepo: <size:27>4.6.1. save(job)</size>
    activate JobRepo
    JobRepo --> JobSvc: <size:27>4.6.2. saved Job</size>
    deactivate JobRepo

    JobSvc -> JobSvc: <size:27>4.7. convertToResponseDTO(savedJob)</size>
    JobSvc --> BookingSvc: <size:27>4.8. JobResponseDTO</size>
    deactivate JobSvc

    BookingSvc -> NotifSvc: <size:27>5.1. saveNotification</size>
    activate NotifSvc
    NotifSvc -> NotifRepo: <size:27>5.1.1. save(notification)</size>
    activate NotifRepo
    NotifRepo --> NotifSvc: <size:27>5.1.2. Notification</size>
    deactivate NotifRepo
    NotifSvc --> BookingSvc: <size:27>5.2. Notification</size>
    deactivate NotifSvc

    BookingSvc --> Controller: <size:27>6. JobResponseDTO</size>
    deactivate BookingSvc

    Controller -> WebSocket: <size:27>7.1. convertAndSend\n<size:27>("/topic/new-job/"+serviceId, jobResponseDTO)</size>
    activate WebSocket
    WebSocket --> WebSocket: <size:27>7.1.1. broadcast</size> \n <size:27>to subscribers</size>
    deactivate WebSocket

    Controller -> Controller: <size:27>8. build ApiResponse</size>
    Controller --> Client: <size:27>9. ApiResponse</size>
    deactivate Controller

end

@enduml