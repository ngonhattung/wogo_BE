@startuml
!include sequence-style.puml

actor Worker as "<size:27>Worker</size>"
participant "WithdrawalController" as Controller
participant "WithdrawalService" as WithdrawalSvc
participant "WorkerService" as WorkerSvc
participant "WorkerRepository" as WorkerRepo
participant "WorkerWalletRevenueService" as WWRSvc
participant "WorkerWalletRevenueRepository" as WWRRepo
participant "WithdrawalRepository" as WithdrawalRepo
participant "WalletTransactionService" as WTSvc
participant "WalletTransactionRepository" as WTRepo
participant "PaymentService" as PaymentSvc
participant "PaymentRepository" as PaymentRepo

Worker -> Controller: <size:27>1. POST /withdrawals</size>
activate Controller

Controller -> WithdrawalSvc: <size:27>1.1. createWithdrawalRequest(request)</size>
activate WithdrawalSvc

WithdrawalSvc -> WithdrawalSvc: <size:27>SecurityUtils.getCurrentUserId()</size>

WithdrawalSvc -> WorkerSvc: <size:27>2.1. getWorkerByUserId(userId)</size>
activate WorkerSvc
WorkerSvc -> WorkerRepo: <size:27>2.1.1. findByUserId(userId)</size>
activate WorkerRepo
WorkerRepo --> WorkerSvc: <size:27>Worker</size>
deactivate WorkerRepo
WorkerSvc --> WithdrawalSvc: <size:27>Worker</size>
deactivate WorkerSvc

alt <size:27>2.2. Worker Not Found</size>
    WithdrawalSvc --> Controller: <size:27>throw AppException\n<size:27>(WORKER_NOT_FOUND)</size>
    Controller --> Worker: <size:27>Error Response</size>
else <size:27>2.3. Worker Found</size>

    WithdrawalSvc -> WWRSvc: <size:27>2.4. getWalletByUserId()</size>
    activate WWRSvc
    WWRSvc -> WWRRepo: <size:27>2.4.1. findByWorkerId(userId)</size>
    activate WWRRepo
    WWRRepo --> WWRSvc: <size:27>WorkerWalletRevenue (wallet)</size>
    deactivate WWRRepo
    WWRSvc --> WithdrawalSvc: <size:27>WorkerWalletRevenue</size>
    deactivate WWRSvc

    WithdrawalSvc -> WithdrawalSvc: <size:27>3.1. Get revenueBalance</size>
    WithdrawalSvc -> WithdrawalSvc: <size:27>3.2. Check balance >= request.amount</size>

    alt <size:27>3.3. Insufficient Balance</size>
        WithdrawalSvc --> Controller: <size:27>throw AppException\n<size:27>(INSUFFICIENT_BALANCE)</size>
        Controller --> Worker: <size:27>Error Response</size>
    else <size:27>3.4. Sufficient Balance</size>

        WithdrawalSvc -> WithdrawalSvc: <size:27>4.1. createWithdrawal(request, worker)</size>
        note right: <size:27>Build Withdrawal entity\n<size:27>with PENDING status

        WithdrawalSvc -> WithdrawalRepo: <size:27>4.2. save(withdrawal)</size>
        activate WithdrawalRepo
        WithdrawalRepo --> WithdrawalSvc: <size:27>Withdrawal (saved)</size>
        deactivate WithdrawalRepo

        WithdrawalSvc -> WithdrawalSvc: <size:27>4.3. Calculate balanceAfter</size>

        WithdrawalSvc -> WTSvc: <size:27>5.1. saveWalletTransaction</size>
        activate WTSvc
        WTSvc -> WTRepo: <size:27>5.1.1. save(walletTransaction)</size>
        activate WTRepo
        WTRepo --> WTSvc: <size:27>WalletTransaction</size>
        deactivate WTRepo
        deactivate WTSvc
        note right: <size:27>Txn created with WITHDRAW type, PENDING status

        WithdrawalSvc -> PaymentSvc: <size:27>6.1. savePayment(PaymentRequestDTO)</size>
        activate PaymentSvc
        PaymentSvc -> PaymentRepo: <size:27>6.1.1. save(payment)</size>
        activate PaymentRepo
        PaymentRepo --> PaymentSvc: <size:27>Payment</size>
        deactivate PaymentRepo
        deactivate PaymentSvc

        WithdrawalSvc -> WithdrawalSvc: <size:27>7.1. convertToDTO(withdrawal)</size>
        WithdrawalSvc -> WTSvc: <size:27>7.2. Get transactionCode & type</size>
        WithdrawalSvc -> WithdrawalSvc: <size:27>7.3. Set DTO fields</size>

        WithdrawalSvc --> Controller: <size:27>7.4. WithdrawalResponseDTO</size>
        deactivate WithdrawalSvc

        Controller -> Controller: <size:27>8.1. Build ApiResponse</size>
        Controller --> Worker: <size:27>8.2. ApiResponse</size>
        deactivate Controller
    end
end
@enduml