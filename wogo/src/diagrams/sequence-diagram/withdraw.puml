@startuml
!include sequence-style.puml
title Create Withdrawal Request Sequence Diagram

actor Worker
participant "Controller\n(WithdrawalController)" as Controller
participant "WithdrawalService" as WithdrawalSvc
participant "WorkerService" as WorkerSvc
participant "WorkerRepository" as WorkerRepo
participant "<<entity>>\nWorker" as WorkerEntity
participant "WorkerWalletRevenueService" as WWRSvc
participant "WorkerWalletRevenueRepository" as WWRRepo
participant "<<entity>>\nWorkerWalletRevenue" as WWREntity
participant "WithdrawalRepository" as WithdrawalRepo
participant "<<entity>>\nWithdrawal" as WithdrawalEntity
participant "WalletTransactionService" as WTSvc
participant "WalletTransactionRepository" as WTRepo
participant "<<entity>>\nWalletTransaction" as WTEntity
participant "PaymentService" as PaymentSvc
participant "PaymentRepository" as PaymentRepo
participant "<<entity>>\nPayment" as PaymentEntity

Worker -> Controller: POST /withdrawals\n(WithdrawalRequestDTO)
activate Controller

Controller -> WithdrawalSvc: createWithdrawalRequest(request)
activate WithdrawalSvc

== Get Current Worker ==
WithdrawalSvc -> WithdrawalSvc: SecurityUtils.getCurrentUserId()

WithdrawalSvc -> WorkerSvc: getWorkerByUserId(userId)
activate WorkerSvc

WorkerSvc -> WorkerRepo: findByUserId(userId)
activate WorkerRepo
WorkerRepo -> WorkerEntity: query by userId
activate WorkerEntity

alt Worker Not Found
    WorkerEntity --> WorkerRepo: null
    deactivate WorkerEntity
    WorkerRepo --> WorkerSvc: Optional.empty()
    deactivate WorkerRepo
    WorkerSvc --> WithdrawalSvc: throw AppException\n(WORKER_NOT_FOUND)
    WithdrawalSvc --> Controller: Error
    Controller --> Worker: Error Response
else Worker Found
    WorkerEntity --> WorkerRepo: Worker instance
    deactivate WorkerEntity
    WorkerRepo --> WorkerSvc: Worker
    deactivate WorkerRepo
    WorkerSvc --> WithdrawalSvc: Worker
    deactivate WorkerSvc

    == Get Worker Wallet Revenue ==
    WithdrawalSvc -> WWRSvc: getWalletByUserId()
    activate WWRSvc

    WWRSvc -> WWRSvc: SecurityUtils.getCurrentUserId()

    WWRSvc -> WWRRepo: findByWorkerId(userId)
    activate WWRRepo
    WWRRepo -> WWREntity: query by workerId
    activate WWREntity
    WWREntity --> WWRRepo: WorkerWalletRevenue instance
    deactivate WWREntity
    WWRRepo --> WWRSvc: WorkerWalletRevenue
    deactivate WWRRepo

    WWRSvc --> WithdrawalSvc: WorkerWalletRevenue
    deactivate WWRSvc

    == Check Balance ==
    WithdrawalSvc -> WWREntity: getRevenueBalance()
    activate WWREntity
    WWREntity --> WithdrawalSvc: BigDecimal revenueBalance
    deactivate WWREntity

    WithdrawalSvc -> WithdrawalSvc: revenueBalance.compareTo(request.getAmount())

    alt Insufficient Balance (balance < amount)
        WithdrawalSvc --> Controller: throw AppException\n(INSUFFICIENT_BALANCE)
        Controller --> Worker: Error Response
    else Sufficient Balance (balance >= amount)

        == Create Withdrawal Entity ==
        WithdrawalSvc -> WithdrawalSvc: createWithdrawal(request, worker)

        WithdrawalSvc -> WithdrawalSvc: Withdrawal.builder()\n.worker(worker)\n.amount(request.getAmount())\n.bankName(request.getBankName())\n.accountNumber(request.getAccountNumber())\n.accountHolderName(request.getAccountHolderName())\n.status(WithdrawalStatus.PENDING)\n.requestedAt(LocalDateTime.now())\n.build()

        create WithdrawalEntity
        WithdrawalSvc -> WithdrawalEntity: new Withdrawal()
        activate WithdrawalEntity

        == Save Withdrawal ==
        WithdrawalSvc -> WithdrawalRepo: save(withdrawal)
        activate WithdrawalRepo
        WithdrawalRepo -> WithdrawalEntity: persist Withdrawal entity
        WithdrawalEntity --> WithdrawalRepo: saved Withdrawal instance
        WithdrawalRepo --> WithdrawalSvc: Withdrawal
        deactivate WithdrawalRepo

        == Calculate Balance After ==
        WithdrawalSvc -> WithdrawalSvc: balanceAfter = revenueBalance - amount

        == Create Wallet Transaction ==
        WithdrawalSvc -> WTSvc: saveWalletTransaction(WalletTransactionRequestDTO)
        activate WTSvc

        WTSvc -> WTRepo: save(walletTransaction)
        activate WTRepo
        WTRepo -> WTEntity: persist new WalletTransaction\n(amount=withdrawal.amount,\ntransactionType=WITHDRAW,\nstatus=PENDING,\ndescription="Yêu cầu rút số tiền: " + amount + " VNĐ",\nwithdrawal=withdrawal,\nwalletRevenue=walletRevenue,\nbalanceBefore=revenueBalance,\nbalanceAfter=revenueBalance - amount)
        activate WTEntity
        WTEntity --> WTRepo: WalletTransaction instance
        deactivate WTEntity
        WTRepo --> WTSvc: WalletTransaction
        deactivate WTRepo

        WTSvc --> WithdrawalSvc: WalletTransaction
        deactivate WTSvc

        == Create Payment ==
        WithdrawalSvc -> PaymentSvc: savePayment(PaymentRequestDTO)
        activate PaymentSvc

        PaymentSvc -> PaymentRepo: save(payment)
        activate PaymentRepo
        PaymentRepo -> PaymentEntity: persist new Payment\n(walletTransaction=walletTransaction,\namount=withdrawal.amount,\npaymentMethod=BANK_TRANSFER)
        activate PaymentEntity
        PaymentEntity --> PaymentRepo: Payment instance
        deactivate PaymentEntity
        PaymentRepo --> PaymentSvc: Payment
        deactivate PaymentRepo

        PaymentSvc --> WithdrawalSvc: Payment
        deactivate PaymentSvc

        == Build Response ==
        WithdrawalSvc -> WithdrawalSvc: convertToDTO(withdrawal)

        WithdrawalSvc -> WithdrawalEntity: Get withdrawal fields
        WithdrawalEntity --> WithdrawalSvc: Withdrawal data

        WithdrawalSvc -> WTEntity: getTransactionCode()
        activate WTEntity
        WTEntity --> WithdrawalSvc: String transactionCode
        deactivate WTEntity

        WithdrawalSvc -> WTEntity: getTransactionType()
        activate WTEntity
        WTEntity --> WithdrawalSvc: TransactionType.WITHDRAW
        deactivate WTEntity

        WithdrawalSvc -> WithdrawalSvc: responseDTO.setTransactionCode(transactionCode)
        WithdrawalSvc -> WithdrawalSvc: responseDTO.setTransactionType(WITHDRAW)

        WithdrawalSvc --> Controller: WithdrawalResponseDTO
        deactivate WithdrawalSvc
        deactivate WithdrawalEntity

        == Build API Response ==
        Controller -> Controller: ApiResponse.builder()\n.message("Withdrawal request created successfully")\n.result(withdrawalResponseDTO)\n.build()

        Controller --> Worker: ApiResponse<WithdrawalResponseDTO>
        deactivate Controller
    end
end

@enduml
