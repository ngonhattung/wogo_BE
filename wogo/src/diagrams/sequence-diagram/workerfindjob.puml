@startuml
!include sequence-style.puml

actor Worker as "<size:27>Worker</size>"
participant "BookingController" as Controller
participant "BookingService" as BookingSvc
participant "WorkerWalletExpenseService" as WWESvc
participant "WWERepo" as WWERepo
participant "AddressService" as AddressSvc
participant "AddressRepo" as AddressRepo
participant "ServiceService" as ServiceSvc
participant "WSRepo" as WSRepo
participant "JobService" as JobSvc
participant "JobRepo" as JobRepo

Worker -> Controller: <size:27>1. GET /job-available</size>
activate Controller

Controller -> BookingSvc: <size:27>1.1. getListPendingJobsMatchWorker()</size>
activate BookingSvc

BookingSvc -> WWESvc: <size:27>2.1. getWalletByUserId()</size>
activate WWESvc

WWESvc -> WWESvc: <size:27>SecurityUtils.getCurrentUserId()</size>
WWESvc -> WWERepo: <size:27>2.1.1. findByWorkerId(userId)</size>
activate WWERepo
WWERepo --> WWESvc: <size:27>WorkerWalletExpense</size>
deactivate WWERepo

WWESvc --> BookingSvc: <size:27>WorkerWalletExpense</size>
deactivate WWESvc

BookingSvc -> BookingSvc: <size:27>2.2. Get expenseBalance</size>

alt <size:27>2.3. Balance \n<size:27>< MINIMUM_WALLET_BALANCE</size>
    BookingSvc --> Controller: <size:27>throw AppException\n<size:27>(WALLET_BALANCE_NOT_ENOUGH)</size>
    Controller --> Worker: <size:27>Error Response</size>
else <size:27>2.4. Balance \n<size:27>>= MINIMUM_WALLET_BALANCE</size>

    BookingSvc -> BookingSvc: <size:27>SecurityUtils.getCurrentUserId()</size>

    BookingSvc -> AddressSvc: <size:27>3.1. findByWorkerId(workerId)</size>
    activate AddressSvc
    AddressSvc -> AddressRepo: <size:27>3.1.1. findByUserIdAndRole(workerId, "WORKER")</size>
    activate AddressRepo
    AddressRepo --> AddressSvc: <size:27>Address (workerAddress)</size>
    deactivate AddressRepo
    AddressSvc --> BookingSvc: <size:27>Address</size>
    deactivate AddressSvc

    BookingSvc -> ServiceSvc: <size:27>4.1. getAllServicesOfWorker()</size>
    activate ServiceSvc

    ServiceSvc -> WSRepo: <size:27>4.1.1. findByWorkerId(workerId)</size>
    activate WSRepo
    WSRepo --> ServiceSvc: <size:27>List<WorkerService></size>
    deactivate WSRepo

    loop <size:27>For Each WorkerService (Handle Child/Parent)</size>
        ServiceSvc -> ServiceSvc: <size:27>Determine effective service list</size>
        note right: <size:27>Dùng parent service\n<size:27>cho các service con
    end

    ServiceSvc --> BookingSvc: <size:27>List<ServiceResponseDTO></size>
    deactivate ServiceSvc

    BookingSvc -> BookingSvc: <size:27>4.2. Extract serviceIds</size>

    alt <size:27>4.3. ServiceIds is Empty</size>
        BookingSvc --> Controller: <size:27>Collections.emptyList()</size>
        Controller --> Worker: <size:27>Empty Job List</size>
    else <size:27>4.4. ServiceIds Not Empty</size>

        loop <size:27>For Each ServiceId</size>
            BookingSvc -> JobSvc: <size:27>5.1. getJobsByServiceId(serviceId)</size>
            activate JobSvc

            JobSvc -> JobRepo: <size:27>5.1.1. findByServiceIdAndStatus\n<size:27>(serviceId, PENDING)</size>
            activate JobRepo
            JobRepo --> JobSvc: <size:27>List<Job></size>
            deactivate JobRepo

            JobSvc -> JobSvc: <size:27>convert to JobSummaryResponseDTO</size>
            JobSvc --> BookingSvc: <size:27>List<JobSummaryResponseDTO></size>
            deactivate JobSvc
        end

        BookingSvc -> BookingSvc: <size:27>5.2. Flatten all jobs</size>

        loop <size:27>For Each Job</size>
            BookingSvc -> BookingSvc: <size:27>6.1. setDistance(job, workerAddress)</size>

            BookingSvc -> BookingSvc: <size:27>Calculate distance (Haversine)</size>
            note right : <size:27>Haversine formula\n<size:27>d = 2r × arcsin(√(sin²(Δφ/2) + cos(φ1) × cos(φ2) × sin²(Δλ/2)))\n<size:27>where r = Earth radius (6371 km)
            end

            BookingSvc -> BookingSvc: <size:27>6.2. job.setDistance(distance)</size>
        end

        BookingSvc --> Controller: <size:27>6.3. List<JobSummaryResponseDTO></size>
        deactivate BookingSvc

        Controller -> Controller: <size:27>7. Build ApiResponse</size>
        Controller --> Worker: <size:27>7.1. ApiResponse</size>
        deactivate Controller
    end
@enduml