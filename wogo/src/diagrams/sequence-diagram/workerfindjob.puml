@startuml
!include sequence-style.puml
title Worker Find Available Jobs Sequence Diagram (Business-Level, Unified Format)

actor Worker
participant "Controller\n(BookingController)" as Controller
participant "BookingService" as BookingSvc
participant "WorkerWalletExpenseService" as WWESvc
participant "WorkerWalletExpenseRepository" as WWERepo
participant "<<entity>>\nWorkerWalletExpense" as WWEEntity
participant "AddressService" as AddressSvc
participant "AddressRepository" as AddressRepo
participant "<<entity>>\nAddress" as AddressEntity
participant "ServiceService" as ServiceSvc
participant "WorkerServiceRepository" as WSRepo
participant "<<entity>>\nWorkerService" as WSEntity
participant "<<entity>>\nService" as ServiceEntity
participant "JobService" as JobSvc
participant "JobRepository" as JobRepo
participant "<<entity>>\nJob" as JobEntity

Worker -> Controller: GET /job-available
activate Controller

Controller -> BookingSvc: getListPendingJobsMatchWorker()
activate BookingSvc

== Check Wallet Balance ==
BookingSvc -> WWESvc: getWalletByUserId()
activate WWESvc

WWESvc -> WWESvc: SecurityUtils.getCurrentUserId()

WWESvc -> WWERepo: findByWorkerId(userId)
activate WWERepo
WWERepo -> WWEEntity: query by workerId
activate WWEEntity
WWEEntity --> WWERepo: WorkerWalletExpense instance
deactivate WWEEntity
WWERepo --> WWESvc: WorkerWalletExpense
deactivate WWERepo

WWESvc --> BookingSvc: WorkerWalletExpense
deactivate WWESvc

BookingSvc -> WWEEntity: getExpenseBalance()
activate WWEEntity
WWEEntity --> BookingSvc: BigDecimal expenseBalance
deactivate WWEEntity

alt Balance < MINIMUM_WALLET_BALANCE
    BookingSvc --> Controller: throw AppException\n(WALLET_BALANCE_NOT_ENOUGH)
    Controller --> Worker: Error Response
else Balance >= MINIMUM_WALLET_BALANCE

    == Get Worker Address ==
    BookingSvc -> BookingSvc: SecurityUtils.getCurrentUserId()

    BookingSvc -> AddressSvc: findByWorkerId(workerId)
    activate AddressSvc

    AddressSvc -> AddressRepo: findByUserIdAndRole(workerId, "WORKER")
    activate AddressRepo
    AddressRepo -> AddressEntity: query by userId and role=WORKER
    activate AddressEntity
    AddressEntity --> AddressRepo: Address instance
    deactivate AddressEntity
    AddressRepo --> AddressSvc: Address
    deactivate AddressRepo

    AddressSvc --> BookingSvc: Address (workerAddress)
    deactivate AddressSvc

    == Get Worker's Services ==
    BookingSvc -> ServiceSvc: getAllServicesOfWorker()
    activate ServiceSvc

    ServiceSvc -> ServiceSvc: SecurityUtils.getCurrentUserId()

    ServiceSvc -> WSRepo: findByWorkerId(workerId)
    activate WSRepo
    WSRepo -> WSEntity: query by workerId
    activate WSEntity
    WSEntity --> WSRepo: List<WorkerService> instances
    deactivate WSEntity
    WSRepo --> ServiceSvc: List<WorkerService>
    deactivate WSRepo

    loop For Each WorkerService
        ServiceSvc -> WSEntity: getService()
        activate WSEntity
        WSEntity -> ServiceEntity: Service instance
        activate ServiceEntity
        WSEntity --> ServiceSvc: Service
        deactivate WSEntity

        ServiceSvc -> ServiceEntity: getChildServices()
        alt Has Child Services
            ServiceEntity --> ServiceSvc: List<Service> children
            note right: If service has children\n(e.g., "Plumbing" has\n"Fix Pipe", "Install Sink")
        else No Child Services
            ServiceEntity --> ServiceSvc: null or empty
            ServiceSvc -> ServiceEntity: getParentService()
            ServiceEntity --> ServiceSvc: Service parent
            note right: Use parent service itself
        end
        deactivate ServiceEntity
    end

    ServiceSvc -> ServiceSvc: Flatten to List<ServiceResponseDTO>
    ServiceSvc --> BookingSvc: List<ServiceResponseDTO>
    deactivate ServiceSvc

    BookingSvc -> BookingSvc: Extract serviceIds from services
    BookingSvc -> BookingSvc: serviceIds = services.stream()\n.map(ServiceResponseDTO::getId)\n.toList()

    alt ServiceIds is Empty
        BookingSvc --> Controller: Collections.emptyList()
        Controller --> Worker: Empty Job List
    else ServiceIds Not Empty

        == Get Jobs by Service IDs ==
        loop For Each ServiceId
            BookingSvc -> JobSvc: getJobsByServiceId(serviceId)
            activate JobSvc

            JobSvc -> JobRepo: findByServiceIdAndStatus(serviceId, PENDING)
            activate JobRepo
            JobRepo -> JobEntity: query by serviceId and status=PENDING
            activate JobEntity
            JobEntity --> JobRepo: List<Job> instances
            deactivate JobEntity
            JobRepo --> JobSvc: List<Job>
            deactivate JobRepo

            JobSvc -> JobSvc: convert to JobSummaryResponseDTO
            JobSvc --> BookingSvc: List<JobSummaryResponseDTO>
            deactivate JobSvc
        end

        BookingSvc -> BookingSvc: Flatten all jobs to single list

        == Calculate Distance for Each Job ==
        loop For Each Job
            BookingSvc -> BookingSvc: setDistance(job, workerAddress)

            BookingSvc -> BookingSvc: haversine(HaversineRequestDTO.builder()\n.latCustomer(job.getLatitude())\n.lonCustomer(job.getLongitude())\n.latWorker(workerAddress.getLatitude())\n.lonWorker(workerAddress.getLongitude())\n.build())

            note right: Calculate distance using\nHaversine formula:\nd = 2r × arcsin(√(sin²(Δφ/2) + cos(φ1) × cos(φ2) × sin²(Δλ/2)))\nwhere r = Earth radius (6371 km)

            BookingSvc -> BookingSvc: job.setDistance(distance)
        end

        BookingSvc --> Controller: List<JobSummaryResponseDTO>
        deactivate BookingSvc

        Controller -> Controller: ApiResponse.builder()\n.message("Pending jobs retrieved successfully")\n.result(jobList)\n.build()

        Controller --> Worker: ApiResponse<List<JobSummaryResponseDTO>>
        deactivate Controller
    end
end

@enduml
