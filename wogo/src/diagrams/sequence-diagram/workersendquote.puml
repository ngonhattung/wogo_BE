@startuml
!include sequence-style.puml
title Worker Send Quote Sequence Diagram (Business-Level, Unified Format)

actor Worker
participant "Controller\n(BookingController)" as Controller
participant "BookingService" as BookingSvc
participant "JobService" as JobSvc
participant "JobRepository" as JobRepo
participant "<<entity>>\nJob" as JobEntity
participant "<<entity>>\nUser" as UserEntity
participant "WorkerService" as WorkerSvc
participant "WorkerRepository" as WorkerRepo
participant "<<entity>>\nWorker" as WorkerEntity
participant "<<entity>>\nWorkerQuote" as QuoteEntity
participant "<<entity>>\nService" as ServiceEntity
participant "MessagingTemplate\n(WebSocket)" as WebSocket

Worker -> Controller: POST /send-quote\n(SendQuoteRequestDTO)
activate Controller

== Verify Job Request ==
Controller -> BookingSvc: verifyJobRequest(request)
activate BookingSvc

BookingSvc -> BookingSvc: getJobAndValidate(request)

== Get Job by Request Code ==
BookingSvc -> JobSvc: getJobByJobRequestCode(jobRequestCode)
activate JobSvc

JobSvc -> JobRepo: findByJobRequestCode(jobRequestCode)
activate JobRepo
JobRepo -> JobEntity: query by jobRequestCode
activate JobEntity

alt Job Not Found
    JobEntity --> JobRepo: null
    deactivate JobEntity
    JobRepo --> JobSvc: Optional.empty()
    deactivate JobRepo
    JobSvc --> BookingSvc: throw AppException\n(JOB_NOT_FOUND)
    BookingSvc --> Controller: Error
    Controller --> Worker: Error Response
else Job Found
    JobEntity --> JobRepo: Job instance
    deactivate JobEntity
    JobRepo --> JobSvc: Optional<Job>
    deactivate JobRepo

    JobSvc -> JobSvc: convertToResponseDTO(job)
    JobSvc --> BookingSvc: JobResponseDTO
    deactivate JobSvc

    == Validate Job Status ==
    BookingSvc -> BookingSvc: Check job.getStatus()

    alt Status != PENDING
        BookingSvc --> Controller: return null → isValid = false

        == Send Error via WebSocket ==
        Controller -> Controller: SecurityUtils.getCurrentUserId()
        Controller -> WebSocket: convertAndSendToUser(\nuserId.toString(),\n"/queue/errors",\n"Job is not available")
        activate WebSocket
        WebSocket --> WebSocket: Send to specific worker
        note right: Private message to\nthis worker only
        deactivate WebSocket

        Controller --> Worker: ApiResponse\n(message="Job request is no longer available")

    else Status = PENDING

        == Get Current Worker ==
        BookingSvc -> BookingSvc: SecurityUtils.getCurrentUserId()

        BookingSvc -> WorkerSvc: getWorkerByUserId(userId)
        activate WorkerSvc

        WorkerSvc -> WorkerRepo: findByUserId(userId)
        activate WorkerRepo
        WorkerRepo -> WorkerEntity: query by userId
        activate WorkerEntity

        alt Worker Not Found
            WorkerEntity --> WorkerRepo: null
            deactivate WorkerEntity
            WorkerRepo --> WorkerSvc: Optional.empty()
            deactivate WorkerRepo
            WorkerSvc --> BookingSvc: throw AppException\n(WORKER_NOT_FOUND)
            BookingSvc --> Controller: Error
            Controller --> Worker: Error Response
        else Worker Found
            WorkerEntity --> WorkerRepo: Worker instance
            deactivate WorkerEntity
            WorkerRepo --> WorkerSvc: Worker
            deactivate WorkerRepo
            WorkerSvc --> BookingSvc: Worker
            deactivate WorkerSvc

            == Get Job Owner ==
            BookingSvc -> JobEntity: getUser()
            activate JobEntity
            JobEntity -> UserEntity: User instance (job owner)
            activate UserEntity
            JobEntity --> BookingSvc: User
            deactivate JobEntity

            BookingSvc -> UserEntity: getId()
            UserEntity --> BookingSvc: Long jobOwnerId

            == Check if Worker is Job Owner ==
            BookingSvc -> WorkerEntity: getId()
            activate WorkerEntity
            WorkerEntity --> BookingSvc: Long currentWorkerId
            deactivate WorkerEntity

            alt Worker is Job Owner (userId == jobOwnerId)
                BookingSvc --> Controller: throw AppException\n(CANNOT_ACCEPT_OWN_JOB)
                Controller --> Worker: Error Response
            else Worker is Not Job Owner

                == Check Existing Quotes ==
                BookingSvc -> JobEntity: getWorkerQuotes()
                activate JobEntity
                JobEntity -> QuoteEntity: List<WorkerQuote> instances
                activate QuoteEntity
                QuoteEntity --> JobEntity: List<WorkerQuote>
                deactivate QuoteEntity
                JobEntity --> BookingSvc: List<SendQuotedResponseDTO>
                deactivate JobEntity

                alt Worker Already Sent Quote
                    BookingSvc -> BookingSvc: existingQuotes.stream()\n.anyMatch(quote -> quote.getWorker().getId() == currentWorkerId)
                    BookingSvc --> Controller: throw AppException\n(YOU_ALREADY_SEND_QUOTE)
                    Controller --> Worker: Error Response
                else Worker Has Not Sent Quote

                    BookingSvc --> BookingSvc: return JobResponseDTO → isValid = true
                    BookingSvc --> Controller: true
                    deactivate BookingSvc

                    == Get Job Details ==
                    Controller -> JobSvc: getJobByJobRequestCode(jobRequestCode)
                    activate JobSvc

                    JobSvc -> JobRepo: findByJobRequestCode(jobRequestCode)
                    activate JobRepo
                    JobRepo -> JobEntity: query by jobRequestCode
                    activate JobEntity
                    JobEntity --> JobRepo: Job instance
                    deactivate JobEntity
                    JobRepo --> JobSvc: Job
                    deactivate JobRepo

                    JobSvc -> JobSvc: convertToResponseDTO(job)

                    JobSvc -> JobEntity: getService()
                    activate JobEntity
                    JobEntity -> ServiceEntity: Service instance
                    activate ServiceEntity
                    JobEntity --> JobSvc: Service
                    deactivate JobEntity

                    JobSvc --> Controller: JobResponseDTO
                    deactivate JobSvc

                    == Broadcast Quote to Customer via WebSocket ==
                    Controller -> ServiceEntity: getId()
                    ServiceEntity --> Controller: Long serviceId

                    Controller -> WebSocket: convertAndSend(\n"/topic/send-quote/" + serviceId,\njobResponseDTO)
                    activate WebSocket
                    WebSocket --> WebSocket: Broadcast to customers\nsubscribed to this service
                    note right: Customer subscribes to\n/topic/send-quote/{serviceId}\nto receive quotes
                    deactivate WebSocket

                    note over Controller: Worker should subscribe to:\n/topic/job-placed/{jobRequestCode}\nto receive customer's response\n(accept or reject)

                    == Save Quote ==
                    Controller -> BookingSvc: sendQuote(request)
                    activate BookingSvc

                    BookingSvc -> BookingSvc: Save WorkerQuote entity\n(details not shown)

                    BookingSvc --> Controller: WorkerQuoteResponseDTO
                    deactivate BookingSvc

                    == Build Response ==
                    Controller -> Controller: ApiResponse.builder()\n.message("Job accepted successfully")\n.result(workerQuoteResponseDTO)\n.build()

                    Controller --> Worker: ApiResponse<WorkerQuoteResponseDTO>
                    deactivate Controller
                    deactivate ServiceEntity
                    deactivate UserEntity
                end
            end
        end
    end
end

@enduml
