@startuml
!include sequence-style.puml

actor Worker as "<size:27>Worker</size>"
participant "BookingController" as Controller
participant "BookingService" as BookingSvc
participant "JobService" as JobSvc
participant "JobRepository" as JobRepo
participant "WorkerService" as WorkerSvc
participant "WorkerRepository" as WorkerRepo
participant "MessagingTemplate\n(WebSocket)" as WebSocket

Worker -> Controller: <size:27>1. POST /send-quote</size>
activate Controller

Controller -> BookingSvc: <size:27>1.1. verifyJobRequest(request)</size>
activate BookingSvc

BookingSvc -> JobSvc: <size:27>2.1. getJobByJobRequestCode(code)</size>
activate JobSvc
JobSvc -> JobRepo: <size:27>2.1.1. findByJobRequestCode(code)</size>
activate JobRepo
JobRepo --> JobSvc: <size:27>Optional<Job></size>
deactivate JobRepo

alt <size:27>2.2. Job Not Found</size>
    JobSvc --> BookingSvc: <size:27>throw AppException\n<size:27>(JOB_NOT_FOUND)</size>
    BookingSvc --> Controller: <size:27>Error</size>
    Controller --> Worker: <size:27>Error Response</size>
else <size:27>2.3. Job Found</size>
    JobSvc --> BookingSvc: <size:27>JobResponseDTO</size>
    deactivate JobSvc

    BookingSvc -> BookingSvc: <size:27>3.1. Check job.getStatus()</size>

    alt <size:27>3.2. Status != PENDING</size>
        BookingSvc --> Controller: <size:27>return false</size>

        Controller -> WebSocket: <size:27>3.2.1. convertAndSendToUser\n<size:27>(userId, "/queue/errors", "Job is not available")</size>
        activate WebSocket
        note right: <size:27>Private message \n<size:27>to this worker
        deactivate WebSocket

        Controller --> Worker: <size:27>ApiResponse (Job unavailable)</size>

    else <size:27>3.3. Status = PENDING (Proceed)</size>

        BookingSvc -> BookingSvc: <size:27>SecurityUtils.getCurrentUserId()</size>

        BookingSvc -> WorkerSvc: <size:27>4.1. getWorkerByUserId(userId)</size>
        activate WorkerSvc
        WorkerSvc -> WorkerRepo: <size:27>4.1.1. findByUserId(userId)</size>
        activate WorkerRepo
        WorkerRepo --> WorkerSvc: <size:27>Worker</size>
        deactivate WorkerRepo
        WorkerSvc --> BookingSvc: <size:27>Worker</size>
        deactivate WorkerSvc

        BookingSvc -> BookingSvc: <size:27>4.2. Get jobOwnerId (from Job Entity)</size>

        alt <size:27>4.3. Worker is Job Owner \n<size:27>(userId == jobOwnerId)</size>
            BookingSvc --> Controller: <size:27>throw AppException\n<size:27>(CANNOT_ACCEPT_OWN_JOB)</size>
            Controller --> Worker: <size:27>Error Response</size>
        else <size:27>4.4. Worker is Not Job Owner</size>

            BookingSvc -> JobSvc: <size:27>5.1. Check Existing Quotes</size>
            note right: <size:27>getWorkerQuotes() from JobEntity

            alt <size:27>5.2. Worker Already Sent Quote</size>
                BookingSvc --> Controller: <size:27>throw AppException\n<size:27>(YOU_ALREADY_SEND_QUOTE)</size>
                Controller --> Worker: <size:27>Error Response</size>
            else <size:27>5.3. Worker Has Not Sent Quote</size>
                BookingSvc --> Controller: <size:27>return true</size>
                deactivate BookingSvc

                Controller -> JobSvc: <size:27>6.1. getJobByJobRequestCode(code)</size>
                activate JobSvc
                JobSvc -> JobRepo: <size:27>6.1.1. findByJobRequestCode(code)</size>
                activate JobRepo
                JobRepo --> JobSvc: <size:27>Job</size>
                deactivate JobRepo
                JobSvc -> JobSvc: <size:27>6.1.2. Get Service & Convert to DTO</size>
                JobSvc --> Controller: <size:27>JobResponseDTO</size>
                deactivate JobSvc

                Controller -> Controller: <size:27>6.2. Get serviceId</size>

                Controller -> WebSocket: <size:27>6.3. convertAndSend\n<size:27>("/topic/send-quote/" + serviceId, jobResponseDTO)</size>
                activate WebSocket
                note right: <size:27>Broadcast to customers \n<size:27>subscribed to this service
                deactivate WebSocket

                Controller -> BookingSvc: <size:27>7.1. sendQuote(request)</size>
                activate BookingSvc
                BookingSvc -> BookingSvc: <size:27>Save WorkerQuote entity</size>
                BookingSvc --> Controller: <size:27>WorkerQuoteResponseDTO</size>
                deactivate BookingSvc

                Controller -> Controller: <size:27>8.1. Build ApiResponse</size>

                Controller --> Worker: <size:27>8.2. ApiResponse</size>
                deactivate Controller
            end
        end
    end
end
@enduml